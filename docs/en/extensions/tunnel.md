### Túnel
| Endereço                     | URI base      | Permissões requeridas   | C#              |
|------------------------------|---------------|-------------------------|-----------------|
| postmaster@tunnel.msging.net | N/A | Nenhuma | [TunnelExtension](https://github.com/takenet/messaginghub-client-csharp/blob/master/src/Takenet.MessagingHub.Client/Extensions/Tunnel/TunnelExtension.cs) |

The **tunnel** extension allows routing and exchange of messages and notifications between different *chatbots* of the BLiP platform. In this way, a **sender** bot can forward received messages to a **receiver** bot in a transparent way, and the mechanism of reception for this is exactly the same as the messages coming from external channels (Messenger, Telegram, SMS , BLiP Chat, etc.). Therefore, the receiver bot **does not need to be specifically implemented** to receive forwarded messages, and the notifications and response messages generated by the receivers are automatically forwarded to the sender.

This feature is useful for **isolating different parts of navigation in independent bots** with only one published on the channel. For example, imagine that you want to have a chatbot on a same Facebook page that has an automatic navigation (static answers), part questions and answers and part attendance made by an human operator. You would then need a bot **main** (SDK / Webhook) that will act as a *switcher* and three **sub-bots** - the first of the SDK/Webhook template, the second FAQ and the last human operator. These last three **would not be published directly on the channel**, but would only receive messages from the main bot, this one - published on Facebook and other channels. The main bot would be the **sender** and the other **receivers** of the tunnel.

*Note: The BLiP portal offers the **master** template that uses the tunnel extension and acts as a switcher for the sub-bots, so the implementation is not necessary in most cases.*

To create a tunnel between two *chatbots*, the **sender** needs to send a message to a address using the following convention:

```
[receiver-identifier]@tunnel.msging.net/[originator-address]
```
Where:
- **receiver-identifier** - The identifier of the  O identificador do bot que deve receber a mensagem encaminhada
- **originator-address** - Endereço original da mensagem externa utilizando codificação *URL encode* (ex: substituindo o '@' por '%40')

O receptor recebe mensagens, envia notificações e mensagens de resposta a um endereço no seguinte formato:

```
[id-do-tunnel]@tunnel.msging.net
```
Onde:
- **id-do-tunnel** - Um identificador único do túnel, composto pela tríade **emissor**, **receptor** e **originador** (endereço original de quem enviou a mensagem).

#### Exemplo

1 - Imagine um cenário onde existam dois bots: **flow** e **operator**, sendo o primeiro responsável por apresentar uma navegação automática e o segundo receber o transbordo de um eventual atendimento manual. Somente o bot **flow** está publicado no *Messenger* e este, em determinado ponto do seu fluxo, precisa encaminhar as mensagens ao bot **operator** que faz o controle do atendimento manual.

O caminho completo de uma mensagem deste o canal externo até o bot de atendimento é o seguinte:

a) O bot principal recebe uma mensagem de um usuário do Messenger.
```json
{
    "id": "1",
    "from": "1654804277843415@messenger.gw.msging.net",
    "to": "flow@msging.net/instance",
    "type": "text/plain",
    "content": "Olá, gostaria de ser atendido."
}
```

b) De acordo com suas regras internas, o bot principal decide encaminhar esta mensagem ao bot de atendimento. Para isso, ele troca o destinatário da mensagem e realiza o envio.

```json
{
    "id": "1",
    "from": "flow@msging.net/instance",
    "to": "operator@tunnel.msging.net/1654804277843415%40messenger.gw.msging.net",
    "type": "text/plain",
    "content": "Olá, gostaria de ser atendido."
}
```

c) Internamente, o servidor cria um **id** para o tunel e encaminha a mensagem ao bot **operator**, que a recebe da seguinte forma:

```json
{
    "id": "1",
    "from": "ecb99cf5-fb5c-4376-8acd-4b478091de15@tunnel.msging.net",
    "to": "operator@msging.net",    
    "type": "text/plain",
    "content": "Olá, gostaria de ser atendido."
}
```

d) O bot operator gera uma resposta para a mensagem e a encaminha para o endereço de origem, **sem diferenciação de uma mensagem recebida diretamente de um canal** (o mesmo vale para notificações de entrega/leitura):

```json
{
    "id": "2",
    "from": "operator@msging.net/instance",
    "to": "ecb99cf5-fb5c-4376-8acd-4b478091de15@tunnel.msging.net",    
    "type": "text/plain",
    "content": "Olá, meu nome é André. Como posso te ajudar?"
}
```

e) O servidor, a partir do **id** do túnel, troca o endereço da mensagem de resposta e a encaminha para o bot **flow**:

```json
{
    "id": "2",
    "from": "operator@tunnel.msging.net/1654804277843415%40messenger.gw.msging.net",
    "to": "flow@msging.net/instance",    
    "type": "text/plain",
    "content": "Olá, meu nome é André. Como posso te ajudar?"
}
```
f) O bot flow identifica a mensagem recebida de um **receptor**, descodifica o endereço original que está na **instância** e envia a mensagem ao destinatário final:
```json
{
    "id": "2",
    "from": "flow@msging.net/instance",
    "to": "1654804277843415@messenger.gw.msging.net",    
    "type": "text/plain",
    "content": "Olá, meu nome é André. Como posso te ajudar?"
}
```

2 - A extensão **túnel** também permite a consulta a informações do originador da mensagem no **diretório**, desde que as informações estejam armazenadas na agenda de contatos do bot **emissor**. Para isso, basta utilizar a mesma mecânica definida nesta extensão:

Enviando um comando para a consulta no diretório utilizando o **id** do túnel:

```json
{
    "id": "3",
    "from": "operator@msging.net/instance",
    "to": "postmaster@tunnel.msging.net",    
    "method":"get",
    "uri": "lime://tunnel.msging.net/accounts/ecb99cf5-fb5c-4376-8acd-4b478091de15"
}
```

O servidor identifica que a consulta é para um usuário do túnel e realiza a consulta **em nome do emissor** diretamente em sua agenda de contatos e retorna a informação:

```json
{
    "id": "3",
    "from": "postmaster@tunnel.gw.msging.net",    
    "to": "operator@msging.net/instance",
    "method":"get",
    "status": "success",
    "type": "application/vnd.lime.account+json",
    "resource": {
        "fullName": "João da Silva",
        "gender": "male"
    }    
}
```
Para maiores informações sobre a agenda de contatos, consulte a [documentação desta extensão](https://portal.blip.ai/#/docs/extensions/contacts).
