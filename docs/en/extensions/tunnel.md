### Tunnel
| Address                      | Base URI      |  C#             |
|------------------------------|---------------|-----------------|
| postmaster@tunnel.msging.net | N/A           | [TunnelExtension](https://github.com/takenet/blip-sdk-csharp/tree/master/src/Take.Blip.Client/Extensions/Tunnel/TunnelExtension.cs) |

The **tunnel** extension allows routing and exchange of messages and notifications between different *chatbots* of the BLiP platform. In this way, a **sender** bot can forward received messages to a **receiver** bot in a transparent way, and the mechanism of reception for this is exactly the same as the messages coming from external channels (Messenger, Telegram, SMS , BLiP Chat, etc.). Therefore, the receiver bot **does not need to be specifically implemented** to receive forwarded messages, and the notifications and response messages generated by the receivers are automatically forwarded to the sender.

This feature is useful for **isolating different parts of navigation in independent bots** with only one published on the channel. For example, imagine that you want to have a chatbot on a same Facebook page that has an automatic navigation (static answers), part questions and answers and part attendance made by an human operator. You would then need a bot **main** (SDK / Webhook) that will act as a *switcher* and three **sub-bots** - the first of the SDK/Webhook template, the second FAQ and the last human operator. These last three **would not be published directly on the channel**, but would only receive messages from the main bot, this one - published on Facebook and other channels. The main bot would be the **sender** and the other **receivers** of the tunnel.

*Note: The BLiP portal offers the [**master** template](https://portal.blip.ai/#/docs/templates/master) that uses the tunnel extension and acts as a switcher for the sub-bots, so the implementation is not necessary in most cases.*

To create a tunnel between two *chatbots*, the **sender** needs to send a message to a address using the following convention:

```
[receiver-identifier]@tunnel.msging.net/[originator-address]
```
Where:
- **receiver-identifier** - The identifier of the bot that should receive the forwarded message
- **originator-address** - Original address of the external message, with URL encoding (replacing the '@' for '%40', for instance)

The receiver receive messages, send notifications and response messages to a adress in the following format:

```
[tunnel-id]@tunnel.msging.net
```
Where:
- **tunnel-id** - Unique tunnel id, which represents the **sender**, **receiver** and **originator** (original address of who sent the message) addresses.

#### Examples

1 - Imagine a scenario where there are two bots: **flow** and **operator**, where the first responsible for presenting an automatic navigation and the second receiving the handover of an eventual manual attendance. Only the **flow** bot is published in *Messenger* and it needs, at a certain point in its flow, to forward the messages to the **operator** bot that controls the manual attendance.

The complete path of a message from this external channel to the service bot is:

a) The main bot receives a message from a Messenger user.
```json
{
    "id": "1",
    "from": "1654804277843415@messenger.gw.msging.net",
    "to": "flow@msging.net/instance",
    "type": "text/plain",
    "content": "Hello, I would like to talk to an attendant."
}
```

b) According to its internal rules, the flow bot decides to forward this message to the operator bot. To do this, it changes the recipient of the message and sends it as bellow:

```json
{
    "id": "1",
    "from": "flow@msging.net/instance",
    "to": "operator@tunnel.msging.net/1654804277843415%40messenger.gw.msging.net",
    "type": "text/plain",
    "content": "Hello, I would like to talk to an attendant."
}
```

c) Internally, the server creates an **id** for the tunnel and forwards the message to the **operator** bot, which receives it as follows:

```json
{
    "id": "1",
    "from": "ecb99cf5-fb5c-4376-8acd-4b478091de15@tunnel.msging.net",
    "to": "operator@msging.net",    
    "type": "text/plain",
    "content": "Hello, I would like to talk to an attendant."
}
```

d) The operator bot generates a reply to the message and forwards it to the source address, **without differentiating a message received directly from a channel** (the same goes for received/consumed notifications):

```json
{
    "id": "2",
    "from": "operator@msging.net/instance",
    "to": "ecb99cf5-fb5c-4376-8acd-4b478091de15@tunnel.msging.net",    
    "type": "text/plain",
    "content": "Hi, my name is Andre. How may I help you?"
}
```

e) The server uses the tunnel **id** to change the address of the response message and forwards it to the **flow** bot:

```json
{
    "id": "2",
    "from": "operator@tunnel.msging.net/1654804277843415%40messenger.gw.msging.net",
    "to": "flow@msging.net/instance",    
    "type": "text/plain",
    "content": "Hi, my name is Andre. How may I help you?"
}
```

f) The bot flow identifies the message received from a **receiver**, decodes the original address that is in **instance** and sends the message to the final recipient:

```json
{
    "id": "2",
    "from": "flow@msging.net/instance",
    "to": "1654804277843415@messenger.gw.msging.net",    
    "type": "text/plain",
    "content": "Hi, my name is Andre. How may I help you?"
}
```

2 - The **tunnel** extension also allows querying information from the message originator in the **directory**, as long as the information is stored in the contact roster of the **sender** bot. To use this feature, the bot just need to send a common directory request:

Sending a command to the query in the directory using the the tunnel **id**:

```json
{
    "id": "3",
    "from": "operator@msging.net/instance",
    "to": "postmaster@tunnel.msging.net",    
    "method":"get",
    "uri": "lime://tunnel.msging.net/accounts/ecb99cf5-fb5c-4376-8acd-4b478091de15"
}
```
The server identifies that the query is for a tunnel user and performs the query **on behalf of the sender** directly in its contacts roster and returns the information:

```json
{
    "id": "3",
    "from": "postmaster@tunnel.msging.net",    
    "to": "operator@msging.net/instance",
    "method":"get",
    "status": "success",
    "type": "application/vnd.lime.account+json",
    "resource": {
        "fullName": "John Deere",
        "gender": "male"
    }    
}
```
For more information about the contacts extension, please refer to the [extension documentation](https://portal.blip.ai/#/docs/extensions/contacts).
